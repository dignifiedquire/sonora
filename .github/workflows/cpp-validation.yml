name: C++ Validation

on:
  push:
    branches: [main]
  pull_request:
  schedule:
    - cron: "0 6 * * 1" # Weekly on Monday
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # Run the C++ test suite with the Rust backend replacing the C++ pipeline.
  validate:
    name: C++ Test Suite (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true

      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - uses: davidB/rust-cargo-make@v1

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: cargo make cpp-deps

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install meson ninja abseil protobuf pkg-config || true

      - name: Debug meson environment (macOS only)
        if: runner.os == 'macOS'
        run: |
          cargo build --release -p sonora-ffi
          cd cpp
          rm -rf builddir

          meson setup builddir -Dtests=enabled -Drust-backend=true \
            -Dprefix="$(pwd)/install" --libdir=lib \
            -Dc_args=-march=native -Dcpp_args=-march=native

          # Get the exact compile command, replace -c with -E to preprocess
          echo "=== Preprocessing sinc_resampler.cc with exact meson flags ==="
          cd builddir
          python3 -c "
          import json
          cmds = json.load(open('compile_commands.json'))
          for c in cmds:
              if 'sinc_resampler.cc' in c['file'] and 'push_sinc' not in c['file']:
                  # Replace -o ... -c with -E to get preprocessor output
                  cmd = c['command']
                  # Just preprocess to stdout
                  cmd = cmd.replace(' -o webrtc/common_audio/libcommon_audio.a.p/resampler_sinc_resampler.cc.o', '')
                  cmd = cmd.replace(' -c ', ' -E ')
                  # Remove -MD -MQ -MF dependency tracking
                  import re
                  cmd = re.sub(r'-MD\s+', '', cmd)
                  cmd = re.sub(r'-MQ\s+\S+', '', cmd)
                  cmd = re.sub(r'-MF\s+\S+', '', cmd)
                  print(cmd)
          " > /tmp/preprocess_cmd.sh
          cat /tmp/preprocess_cmd.sh
          bash /tmp/preprocess_cmd.sh 2>/dev/null | grep -A 2 -B 2 'Convolve_NEON\|WEBRTC_ARCH_X86' | head -30
          cd ..

          echo "=== Attempting ninja build ==="
          ninja -C builddir 2>&1 | grep -E 'sinc_resampler|FAILED|error:|Convolve|^ninja' | head -15

          echo "=== Check __x86_64__ in the compile context ==="
          cd builddir
          python3 -c "
          import json
          cmds = json.load(open('compile_commands.json'))
          for c in cmds:
              if 'sinc_resampler.cc' in c['file'] and 'push_sinc' not in c['file']:
                  cmd = c['command']
                  import re
                  cmd = re.sub(r'-MD\s+', '', cmd)
                  cmd = re.sub(r'-MQ\s+\S+', '', cmd)
                  cmd = re.sub(r'-MF\s+\S+', '', cmd)
                  cmd = cmd.replace(' -o webrtc/common_audio/libcommon_audio.a.p/resampler_sinc_resampler.cc.o', '')
                  cmd = cmd.replace(' -c ', ' -E -dM ')
                  cmd = cmd.replace('../webrtc/common_audio/resampler/sinc_resampler.cc', '/dev/null')
                  print(cmd)
          " > /tmp/defs_cmd.sh
          bash /tmp/defs_cmd.sh 2>/dev/null | grep -iE 'x86_64|aarch64|__arm|__APPLE' | head -10

      - name: Run C++ test suite with Rust backend
        run: cargo make cpp-validate
        timeout-minutes: 15

  # Run the Rust vs C++ comparison tests (sonora-bench).
  compare:
    name: Rust/C++ Comparison (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true

      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - uses: davidB/rust-cargo-make@v1

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: cargo make cpp-deps

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install meson ninja abseil protobuf pkg-config || true

      - name: Run Rust vs C++ comparison tests
        run: cargo make cpp-test
