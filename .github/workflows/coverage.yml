name: Coverage

on:
  push:
    branches: [main]
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  rust-coverage:
    name: Rust Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - uses: Swatinem/rust-cache@v2
      - uses: taiki-e/install-action@cargo-llvm-cov
      - uses: taiki-e/install-action@nextest
      - name: Generate coverage
        run: |
          cargo llvm-cov nextest --workspace --codecov --output-path rust-codecov.json
          cargo llvm-cov report --lcov --output-path rust-lcov.info
      - name: Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: rust-codecov.json
          flags: rust
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
      - name: Upload to Coveralls
        uses: coverallsapp/github-action@v2
        with:
          file: rust-lcov.info
          flag-name: rust
          parallel: true

  cpp-rust-coverage:
    name: C++ FFI Coverage
    runs-on: ubuntu-latest
    # The LLVM profiling runtime must be force-linked (--whole-archive) into
    # the GCC-linked test binary for .profraw generation to work.
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - uses: Swatinem/rust-cache@v2
      - uses: taiki-e/install-action@cargo-llvm-cov
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y meson ninja-build libabsl-dev libprotobuf-dev protobuf-compiler pkg-config
      - name: Build instrumented Rust library
        run: |
          # Persist instrumentation env vars for subsequent steps.
          cargo llvm-cov show-env --release 2>/dev/null | tr -d "'" >> "$GITHUB_ENV"
          eval "$(cargo llvm-cov show-env --release)"
          cargo llvm-cov clean --workspace --release
          cargo build --release -p sonora-ffi
      - name: Extract LLVM profiling runtime
        run: |
          # The instrumented libsonora_ffi.a has weak-undefined __llvm_profile_runtime.
          # GCC won't resolve weak symbols from archives, so we extract the LLVM
          # profiling runtime objects into a standalone static library and force-link
          # it via --whole-archive in LDFLAGS.
          SYSROOT=$(rustc --print sysroot)
          HOST=$(rustc -vV | sed -n 's/host: //p')
          PROFILER_RLIB=$(ls "$SYSROOT"/lib/rustlib/"$HOST"/lib/libprofiler_builtins-*.rlib)

          PROFILER_DIR=$(mktemp -d)
          cd "$PROFILER_DIR"
          ar x "$PROFILER_RLIB"
          rm -f *.rmeta lib.rmeta
          # Create a standalone archive that we can --whole-archive link
          ar rcs libllvm_profiler.a *.o
          rm -f *.o
          cd -

          echo "PROFILER_LIB=$PROFILER_DIR/libllvm_profiler.a" >> "$GITHUB_ENV"
      - name: Build C++ with Rust backend and profiling runtime
        working-directory: cpp
        run: |
          # Force-link the LLVM profiling runtime so __llvm_profile_runtime is
          # defined and the atexit handler writes .profraw files.
          export LDFLAGS="-Wl,--whole-archive $PROFILER_LIB -Wl,--no-whole-archive"
          meson setup builddir \
            -Dtests=enabled \
            -Drust-backend=true \
            -Dprefix=${{ github.workspace }}/install
          ninja -C builddir
      - name: Run C++ tests
        working-directory: cpp
        run: |
          meson test -C builddir -v --print-errorlogs
      - name: Check for profraw files
        run: |
          echo "LLVM_PROFILE_FILE=$LLVM_PROFILE_FILE"
          echo "Looking for .profraw files in target/..."
          find target/ -name '*.profraw' -ls 2>/dev/null || true
          PROFRAW_COUNT=$(find target/ -name '*.profraw' 2>/dev/null | wc -l)
          echo "Found $PROFRAW_COUNT .profraw files"
          if [ "$PROFRAW_COUNT" -eq 0 ]; then
            echo "::warning::No .profraw files found â€” profiling runtime may not have fired"
            # Also check for profraw files elsewhere
            find /tmp -name '*.profraw' -ls 2>/dev/null | head -5 || true
          fi
      - name: Generate coverage report
        run: |
          cargo llvm-cov report --release --codecov --output-path cpp-rust-codecov.json
          cargo llvm-cov report --release --lcov --output-path cpp-rust-lcov.info
      - name: Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: cpp-rust-codecov.json
          flags: cpp-ffi
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
      - name: Upload to Coveralls
        uses: coverallsapp/github-action@v2
        with:
          file: cpp-rust-lcov.info
          flag-name: cpp-ffi
          parallel: true

  coveralls-finish:
    name: Coveralls Finish
    needs: [rust-coverage, cpp-rust-coverage]
    if: always()
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Finish Coveralls parallel build
        uses: coverallsapp/github-action@v2
        with:
          parallel-finished: true
