name: Coverage

on:
  push:
    branches: [main]
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  rust-coverage:
    name: Rust Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - uses: Swatinem/rust-cache@v2
      - uses: taiki-e/install-action@cargo-llvm-cov
      - uses: taiki-e/install-action@nextest
      - name: Generate coverage
        run: |
          cargo llvm-cov nextest --workspace --codecov --output-path rust-codecov.json
          cargo llvm-cov report --lcov --output-path rust-lcov.info
      - name: Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: rust-codecov.json
          flags: rust
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
      - name: Upload to Coveralls
        uses: coverallsapp/github-action@v2
        with:
          file: rust-lcov.info
          flag-name: rust
          parallel: true

  cpp-rust-coverage:
    name: C++ FFI Coverage
    runs-on: ubuntu-latest
    # Profraw generation from GCC-linked binaries with LLVM instrumentation is
    # unreliable — the LLVM profiling runtime atexit handler may not fire.
    # Keep the job visible but non-blocking until this is resolved.
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - uses: Swatinem/rust-cache@v2
      - uses: taiki-e/install-action@cargo-llvm-cov
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y meson ninja-build libabsl-dev libprotobuf-dev protobuf-compiler pkg-config
      - name: Build instrumented Rust library
        run: |
          # Persist instrumentation env vars for subsequent steps.
          cargo llvm-cov show-env --release 2>/dev/null | tr -d "'" >> "$GITHUB_ENV"
          eval "$(cargo llvm-cov show-env --release)"
          cargo llvm-cov clean --workspace --release
          cargo build --release -p sonora-ffi
      - name: Build C++ with Rust backend
        working-directory: cpp
        run: |
          meson setup builddir \
            -Dtests=enabled \
            -Drust-backend=true \
            -Dprefix=${{ github.workspace }}/install
          ninja -C builddir
      - name: Inject LLVM profiling runtime and run tests
        working-directory: cpp
        run: |
          # The instrumented libsonora_ffi.a references __llvm_profile_runtime (undefined),
          # which is provided by Rust's profiler_builtins. When GCC links the C++ test
          # binary, it doesn't know about this dependency, so profraw files are never
          # written. Fix: extract the profiling runtime objects from the rlib and append
          # them to libsonora_ffi.a, then re-link the test binary.
          TARGET_DIR=$(cargo metadata --format-version 1 --no-deps --manifest-path ../Cargo.toml | python3 -c "import sys,json; print(json.load(sys.stdin)['target_directory'])")
          SYSROOT=$(rustc --print sysroot)
          HOST=$(rustc -vV | sed -n 's/host: //p')
          PROFILER_RLIB=$(ls "$SYSROOT"/lib/rustlib/"$HOST"/lib/libprofiler_builtins-*.rlib)

          TMPDIR=$(mktemp -d)
          cd "$TMPDIR"
          ar x "$PROFILER_RLIB"
          # Remove Rust metadata — only keep the InstrProfiling object files
          rm -f *.rmeta lib.rmeta
          ar rcs "$TARGET_DIR/release/libsonora_ffi.a" *.o
          cd -
          rm -rf "$TMPDIR"

          # Re-link the test binary to pick up the profiling runtime
          ninja -C builddir
          meson test -C builddir -v --print-errorlogs
      - name: Generate coverage report
        run: |
          cargo llvm-cov report --release --codecov --output-path cpp-rust-codecov.json
          cargo llvm-cov report --release --lcov --output-path cpp-rust-lcov.info
      - name: Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: cpp-rust-codecov.json
          flags: cpp-ffi
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
      - name: Upload to Coveralls
        uses: coverallsapp/github-action@v2
        with:
          file: cpp-rust-lcov.info
          flag-name: cpp-ffi
          parallel: true

  coveralls-finish:
    name: Coveralls Finish
    needs: [rust-coverage, cpp-rust-coverage]
    if: always()
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Finish Coveralls parallel build
        uses: coverallsapp/github-action@v2
        with:
          parallel-finished: true
